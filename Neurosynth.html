<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NeuroSynthesizer v11.0: Clinical Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    /* --- V11 Theme --- */
    :root {
      --bg-dark: #050505;
      --bg-panel: #121212;
      --bg-input: #1e1e1e;
      --accent: #60a5fa;        /* Precision Blue */
      --accent-dim: rgba(96, 165, 250, 0.1);
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #f87171;
      --text-main: #e5e5e5;
      --text-muted: #a3a3a3;
      --border: #333;
      --font-sans: 'Inter', sans-serif;
      --font-serif: 'Merriweather', serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body { background: var(--bg-dark); color: var(--text-main); font-family: var(--font-sans); display: flex; }
    
    /* Layout */
    .app-shell { display: grid; grid-template-columns: 320px 1fr 280px; width: 100%; height: 100%; }
    .sidebar-left { background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
    .sidebar-content { padding: 20px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 20px; }
    .main-stage { padding: 0; display: flex; flex-direction: column; overflow-y: auto; position: relative; scroll-behavior: smooth; }
    .sidebar-right { background: var(--bg-panel); border-left: 1px solid var(--border); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;}

    /* Narrative Header */
    .narrative-container { padding: 30px 40px 10px 40px; max-width: 950px; margin: 0 auto; width: 100%; flex-shrink: 0; }
    .narrative-headline { font-family: var(--font-serif); font-size: 1.6rem; font-weight: 700; color: #fff; margin-bottom: 8px; line-height: 1.2; }
    .narrative-sub { font-family: var(--font-sans); font-size: 0.9rem; color: var(--text-muted); margin-bottom: 25px; font-weight: 300; border-bottom: 1px solid var(--border); padding-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end; }
    .narrative-tag { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; background: var(--bg-input); padding: 4px 8px; border-radius: 4px; color: var(--accent); font-weight: 600; }

    /* Viz Grid */
    .viz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; padding: 0 40px; max-width: 950px; margin: 0 auto; width: 100%; }
    .full-width { grid-column: 1 / -1; }

    /* Viz Containers */
    .viz-container { background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 0; display: flex; flex-direction: column; position: relative; overflow: hidden; min-height: 300px; }
    .viz-header { padding: 10px 15px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.02); display: flex; justify-content: space-between; align-items: center; }
    .viz-title { font-family: var(--font-sans); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); }
    canvas { width: 100%; height: 100%; display: block; flex: 1; }
    .viz-footer { padding: 6px 12px; background: rgba(0,0,0,0.2); font-size: 0.65rem; color: #666; border-top: 1px solid var(--border); font-style: italic; }

    /* Waffle Chart Specifics */
    .waffle-wrapper { padding: 0 40px; max-width: 950px; margin: 0 auto 30px auto; width: 100%; }
    .waffle-legend { display: flex; gap: 20px; justify-content: center; padding-bottom: 15px; font-size: 0.75rem; color: var(--text-muted); }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

    /* Report Section */
    .report-section { background: var(--bg-panel); border-top: 1px solid var(--border); padding: 40px; margin-top: 20px; }
    .report-inner { max-width: 800px; margin: 0 auto; }
    .report-header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
    .report-title { font-family: var(--font-serif); font-size: 1.4rem; color: var(--text-main); margin: 0; }
    .report-block { margin-bottom: 30px; }
    .report-h3 { font-size: 0.9rem; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .report-text { font-family: var(--font-serif); font-size: 1rem; line-height: 1.7; color: #d4d4d4; }
    .report-highlight { background: rgba(96, 165, 250, 0.15); padding: 2px 6px; border-radius: 4px; color: #fff; font-weight: 600; }
    .report-citation { font-family: var(--font-sans); font-size: 0.75rem; color: var(--text-muted); margin-top: 10px; font-style: italic; border-left: 3px solid var(--border); padding-left: 10px; }

    /* Copy Button */
    .copy-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 6px; transition: all 0.2s; font-family: var(--font-sans); }
    .copy-btn:hover { background: var(--bg-input); color: var(--text-main); border-color: var(--text-muted); }
    .copy-btn svg { width: 14px; height: 14px; }

    /* Tooltips */
    .info-icon { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; border-radius: 50%; background: var(--border); color: var(--text-muted); font-size: 10px; cursor: help; margin-left: 6px; }
    .info-icon:hover { background: var(--accent); color: #fff; }
    [data-tooltip]:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 6px 10px; border-radius: 4px; font-size: 0.7rem; white-space: pre-wrap; width: 200px; z-index: 100; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .tooltip-wrapper { position: relative; display: inline-block; }

    /* Controls & Inputs */
    .control-group { display: flex; flex-direction: column; gap: 8px; }
    label { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }
    .val-display { color: var(--accent); font-family: 'JetBrains Mono', monospace; font-weight: 600; }
    
    input[type="range"] { width: 100%; accent-color: var(--accent); height: 4px; background: #333; border-radius: 2px; -webkit-appearance: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--text-main); border-radius: 50%; cursor: pointer; margin-top: -6px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    
    .toggle-container { display: flex; background: var(--bg-input); border-radius: 6px; padding: 4px; border: 1px solid var(--border); }
    .toggle-btn { flex: 1; padding: 8px; text-align: center; cursor: pointer; font-size: 0.75rem; font-weight: 600; border-radius: 4px; color: var(--text-muted); transition: all 0.2s; }
    .toggle-btn.active { background: var(--accent-dim); color: var(--accent); }
    
    .sub-options { margin-top: 8px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; border-left: 2px solid var(--accent); display: none; }
    .sub-options.visible { display: block; }
    .radio-row { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
    .radio-row input { accent-color: var(--accent); }

    .risk-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 12px; border-radius: 6px; }
    .risk-header { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; font-weight: 700; }

    /* Metrics */
    .metric-card { background: var(--bg-input); border-radius: 6px; padding: 12px; border-left: 3px solid var(--border); margin-bottom: 10px; }
    .metric-card.pos { border-color: var(--success); }
    .metric-card.neg { border-color: var(--danger); }
    .metric-card.neutral { border-color: var(--warning); }
    .m-title { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; }
    .m-val { font-size: 1.4rem; font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--text-main); }
    .m-sub { font-size: 0.7rem; color: var(--text-muted); }

    .run-btn { background: var(--text-main); color: var(--bg-dark); border: none; padding: 14px; border-radius: 6px; font-weight: 700; cursor: pointer; margin-top: auto; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; }
    .run-btn:hover { background: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.1); }
    .run-btn:disabled { opacity: 0.6; cursor: wait; }
    
    .loader { width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.3); border-top-color: #000; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    .run-btn.processing .loader { display: block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 1200px) { .app-shell { grid-template-columns: 300px 1fr; } .sidebar-right { display: none; } }
    @media (max-width: 800px) { .app-shell { display: block; overflow-y: auto; height: auto; } .main-stage { display: flex; flex-direction: column; height: auto; } }
  </style>
</head>
<body>

<div class="app-shell">
  <!-- LEFT: CONTROLS -->
  <aside class="sidebar-left">
    <div class="sidebar-content">
      
      <!-- Drug Selection -->
      <div class="control-group">
        <label>
          Therapeutic Agent
          <span class="tooltip-wrapper" data-tooltip="Alteplase is standard. Tenecteplase (TNK) is increasingly used based on EXTEND-IA TNK and AcT trials.">
            <span class="info-icon">?</span>
          </span>
        </label>
        <div class="toggle-container">
          <div class="toggle-btn active" id="btnTPA" onclick="setDrug('tpa')">Alteplase (tPA)</div>
          <div class="toggle-btn" id="btnTNK" onclick="setDrug('tnk')">Tenecteplase</div>
        </div>
        
        <div id="tnkOptions" class="sub-options">
          <div style="font-size:0.65rem; color:#888; margin-bottom:6px; text-transform:uppercase; font-weight:700;">Efficacy Assumption</div>
          <div class="radio-row">
            <input type="radio" name="tnkModel" id="tnkNI" value="ni" checked onchange="startAnalysis()">
            <label for="tnkNI" style="margin:0; font-weight:400;">Non-Inferiority (1.0x)</label>
          </div>
          <div class="radio-row">
            <input type="radio" name="tnkModel" id="tnkSup" value="sup" onchange="startAnalysis()">
            <label for="tnkSup" style="margin:0; font-weight:400;">Superiority (1.05x)</label>
          </div>
        </div>
      </div>

      <!-- Time Slider -->
      <div class="control-group" style="margin-top: 10px;">
        <label>
          Time to Treatment
          <span class="val-display" id="lblTime">90 min</span>
        </label>
        <input type="range" id="timeInput" min="0" max="360" value="90" step="5">
        <div style="font-size:0.7rem; color:#666; font-style:italic;">Log-linear decay applied.</div>
      </div>

      <!-- Risk Calculator -->
      <div class="risk-box">
        <div class="risk-header">Patient Risk (DRAGON)</div>
        <div class="control-group">
          <label>
            Score (0-10)
            <span class="tooltip-wrapper" data-tooltip="DRAGON Score predicts 3-month outcome. Higher score = worse prognosis & higher bleed risk.">
              <span class="info-icon">?</span>
            </span>
            <span id="lblDragon" class="val-display">2</span>
          </label>
          <input type="range" id="dragonInput" min="0" max="10" value="2" step="1" oninput="updateRiskFromScore()">
        </div>
      </div>

      <!-- Manual Adjustments -->
      <div class="control-group">
        <label>Natural Recovery % <span id="lblBaseB" class="val-display">30%</span></label>
        <input type="range" id="baseB" min="5" max="80" value="30" step="1">
      </div>
      <div class="control-group">
        <label>Bleed Risk % <span id="lblBaseH" class="val-display">0.8%</span></label>
        <input type="range" id="baseH" min="0.1" max="15.0" value="0.8" step="0.1">
      </div>

      <div class="control-group" style="border-top: 1px solid var(--border); padding-top: 15px;">
        <label>
          Harm Weight
          <span class="tooltip-wrapper" data-tooltip="How many 'Good Outcomes' are you willing to sacrifice to avoid 1 symptomatic bleed? Standard is 1.5x.">
            <span class="info-icon">?</span>
          </span>
          <span id="lblWeight" class="val-display">1.5x</span>
        </label>
        <input type="range" id="harmWeight" min="1.0" max="5.0" value="1.5" step="0.1">
      </div>

      <button id="runBtn" class="run-btn" onclick="startAnalysis()">
        <div class="loader"></div>
        <span>Synthesize Evidence</span>
      </button>
    </div>
  </aside>

  <!-- CENTER: MAIN STAGE -->
  <main class="main-stage">
    <div class="narrative-container">
      
      <!-- Header -->
      <div id="dynamicHeadline" class="narrative-headline">Initializing Model...</div>
      <div class="narrative-sub">
        <span id="dynamicSubhead">Running simulation...</span>
        <span id="drugTag" class="narrative-tag">Alteplase</span>
      </div>
    </div>

    <!-- 1. Waffle Chart -->
    <div class="waffle-wrapper">
      <div class="viz-container" style="min-height: auto; padding-bottom: 5px; background: transparent; border:none;">
        <div style="text-align: center; margin-bottom: 15px;">
          <span class="viz-title">The 100 Patient Room (Frequencies)</span>
        </div>
        <div style="display: flex; justify-content: center;">
          <canvas id="waffleCanvas" style="max-width: 450px; height: 220px;"></canvas>
        </div>
        <!-- Legend -->
        <div class="waffle-legend">
          <div class="legend-item"><span class="dot" style="background: #10b981;"></span> Gained Independence</div>
          <div class="legend-item"><span class="dot" style="background: #ef4444;"></span> Caused Bleed</div>
          <div class="legend-item"><span class="dot" style="background: #333;"></span> Unchanged</div>
        </div>
      </div>
    </div>

    <!-- 2. Grotta Bar -->
    <div class="viz-grid full-width" style="padding: 0 40px; max-width: 950px; margin: 0 auto 30px auto;">
      <div class="viz-container grotta-container full-width">
        <div class="viz-header">
          <span class="viz-title">Ordinal Shift Analysis (Grotta Bar)</span>
          <span id="shiftMetric" class="viz-title" style="color: var(--success);"></span>
        </div>
        <canvas id="grottaCanvas"></canvas>
        <div class="viz-footer">Projected proportional odds shift. Note: Assumes uniform effect across mRS grades.</div>
      </div>
    </div>

    <!-- Grid -->
    <div class="viz-grid">
      <div class="viz-container">
        <div class="viz-header"><span class="viz-title">Bivariate Density</span></div>
        <canvas id="mainCanvas"></canvas>
      </div>
      
      <div class="viz-container">
        <div class="viz-header"><span class="viz-title">Time Decay</span></div>
        <canvas id="decayCanvas"></canvas>
        <div class="viz-footer">95% Confidence Band (Emberson 2014).</div>
      </div>
      
      <div class="viz-container">
        <div class="viz-header"><span class="viz-title">Forest Plot</span></div>
        <canvas id="forestCanvas"></canvas>
        <div class="viz-footer">Red whiskers: 95% Prediction Interval.</div>
      </div>
      <div class="viz-container">
        <div class="viz-header"><span class="viz-title">Net Benefit Distribution</span></div>
        <canvas id="histCanvas"></canvas>
      </div>
    </div>

    <!-- LIVE REPORT SECTION -->
    <div class="report-section">
      <div class="report-inner">
        <div class="report-header-row">
          <h2 class="report-title">Clinical Analysis Report</h2>
          <button class="copy-btn" onclick="copyReport()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            Copy Report
          </button>
        </div>
        <div id="reportContent">
          <!-- Content Injected via JS -->
        </div>
      </div>
    </div>

  </main>

  <!-- RIGHT: METRICS -->
  <aside class="sidebar-right">
    <h2>Key Metrics</h2>
    
    <div id="ncbBox" class="metric-card neutral">
      <div class="m-title">
        Net Clinical Benefit
        <span class="tooltip-wrapper" data-tooltip="Benefit - (Harm × Disutility). Positive means benefit outweighs harm.">
          <span class="info-icon">?</span>
        </span>
      </div>
      <div class="m-val" id="valNCB">--</div>
      <div class="m-sub" id="subNCB">Weighted % Gain</div>
    </div>

    <div class="metric-card">
      <div class="m-title">Probability(Benefit > Risk)</div>
      <div class="m-val" id="valProb" style="color: var(--accent);">--</div>
    </div>

    <div class="metric-card neutral" style="border-color: var(--text-muted);">
      <div class="m-title">Tipping Point</div>
      <div class="m-val" id="valTip" style="font-size: 1.2rem;">--</div>
      <div class="m-sub">Weight where decision flips</div>
    </div>

    <div style="margin-top: 20px;">
      <div class="m-title" style="margin-bottom: 10px;">Absolute Counts</div>
      <div class="metric-card pos">
        <div class="m-title" style="color: var(--success);">NNT (Benefit)</div>
        <div class="m-val" id="valNNT">--</div>
      </div>
      <div class="metric-card neg" style="margin-top: 10px;">
        <div class="m-title" style="color: var(--danger);">NNH (Harm)</div>
        <div class="m-val" id="valNNH">--</div>
      </div>
    </div>
  </aside>
</div>

<!-- WORKER -->
<script id="worker-code" type="javascript/worker">
  self.onmessage = function(e) {
    const { trials, baseB, baseH, weightH, nSims, rho, timeMin, drugType, tnkModel } = e.data;
    
    // 1. Time Penalty
    let efficacyFactor = 1;
    if (timeMin >= 270) efficacyFactor = 0;
    else {
      const theoreticalOR = Math.max(1.0, 1.8 - (0.00296 * timeMin));
      efficacyFactor = Math.log(theoreticalOR) / Math.log(1.75); 
    }

    // 2. Drug Mod
    let drugMod = 1.0;
    if (drugType === 'tnk' && tnkModel === 'sup') drugMod = 1.05; 

    // 3. Adjust
    const adjustedTrials = trials.map(t => ({
      ...t,
      logOR_benefit: t.logOR_benefit * efficacyFactor * drugMod
    }));

    // 4. REML
    const reB = runREML(adjustedTrials, 'logOR_benefit', 'SE_benefit');
    const reH = runREML(trials, 'logOR_harm', 'SE_harm'); 

    // 5. Monte Carlo
    const plotPoints = []; 
    const ncbValues = [];
    let positiveCount = 0;
    let totalBen = 0;
    let totalHarm = 0;
    let sumB = 0, sumH = 0;

    const sdB = Math.sqrt(reB.se_pool**2 + reB.tau2 + 0.04); 
    const sdH = Math.sqrt(reH.se_pool**2 + reH.tau2 + 0.16); 
    const sqrtRho = Math.sqrt(1 - rho*rho);

    for(let i=0; i<nSims; i++) {
      let u=0, v=0;
      while(u===0) u=Math.random(); while(v===0) v=Math.random();
      const z1 = Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
      while(u===0) u=Math.random(); while(v===0) v=Math.random();
      const z2 = Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);

      const lB = reB.mu + sdB * z1;
      const lH = reH.mu + sdH * (rho * z1 + sqrtRho * z2);

      const aB = oddsToAbs(baseB, lB);
      const aH = oddsToAbs(baseH, lH);
      totalBen += aB; totalHarm += aH;
      sumB += aB; sumH += aH;

      const ncb = aB - (aH * weightH);
      ncbValues.push(ncb); 
      if(ncb > 0) positiveCount++;

      if (i % Math.ceil(nSims/3000) === 0) plotPoints.push({b: aB, h: aH});
    }

    const meanB = sumB / nSims;
    const meanH = sumH / nSims;
    const tippingPoint = meanH > 0.0001 ? (meanB / meanH) : 99.9;

    // 6. Grotta
    const baseDist = [0.13, 0.18, 0.16, 0.14, 0.13, 0.10, 0.16];
    const treatDist = applyOrdinalShift(baseDist, Math.exp(reB.mu));
    const baseGood = baseDist[0] + baseDist[1];
    const treatGood = treatDist[0] + treatDist[1];
    const shiftDelta = treatGood - baseGood;

    // 7. Stats
    const stats = {
      avgNet: ncbValues.reduce((a,b)=>a+b,0)/nSims,
      probPos: positiveCount/nSims,
      avgBen: totalBen/nSims,
      avgHarm: totalHarm/nSims,
      tippingPoint: tippingPoint,
      grotta: { base: baseDist, treat: treatDist, delta: shiftDelta }
    };

    ncbValues.sort((a,b)=>a-b);
    const histData = buildHistogram(ncbValues, 40);

    const pi_B = 2.0 * Math.sqrt(reB.se_pool**2 + reB.tau2);
    reB.pi_lo = reB.mu - pi_B; reB.pi_hi = reB.mu + pi_B;

    self.postMessage({ type: 'complete', data: { reB, reH, plotPoints, histData, stats } });
  };

  function applyOrdinalShift(dist, OR) {
    let cum = [];
    let sum = 0;
    for(let p of dist) { sum+=p; cum.push(sum); }
    cum[cum.length-1] = 1.0; 
    let newCum = cum.map(p => {
      if(p >= 1) return 1;
      const odds = p / (1-p);
      const newOdds = odds * OR; 
      return newOdds / (1+newOdds);
    });
    let newDist = [];
    let prev = 0;
    for(let c of newCum) { newDist.push(c - prev); prev = c; }
    return newDist;
  }

  function oddsToAbs(base, logOR) {
    const o = base/(1-base);
    const n = o*Math.exp(logOR);
    return (n/(1+n)) - base;
  }

  function buildHistogram(arr, bins) {
    const min = arr[0], max = arr[arr.length-1];
    const step = (max-min)/bins;
    const res = [];
    let current = min;
    let idx = 0;
    for(let i=0; i<bins; i++) {
      let count = 0;
      const next = current + step;
      while(idx < arr.length && arr[idx] < next) { count++; idx++; }
      res.push({ x: current + step/2, y: count });
      current = next;
    }
    return res;
  }

  function runREML(data, kEff, kSe) {
    const y = data.map(d=>d[kEff]);
    const v = data.map(d=>d[kSe]**2);
    let tau2 = 0.02;
    for(let i=0; i<50; i++) {
      const w = v.map(x => 1/(x+tau2));
      const sw = w.reduce((a,b)=>a+b,0);
      const sw2 = w.reduce((a,b)=>a+b*b,0);
      const mu = w.reduce((a,b,j)=>a+b*y[j],0)/sw;
      let q = 0;
      y.forEach((val,j) => q += w[j]*w[j]*((val-mu)**2 - v[j] - tau2 + 1/sw));
      const info = 0.5*(sw2 - sw2*sw2/sw);
      const d = (0.5*q)/Math.max(info, 1e-12);
      tau2 = Math.max(0, tau2+d);
      if(Math.abs(d) < 1e-9) break;
    }
    const w = v.map(x => 1/(x+tau2));
    const sw = w.reduce((a,b)=>a+b,0);
    return {
      mu: w.reduce((a,b,j)=>a+b*y[j],0)/sw,
      se_pool: Math.sqrt(1/sw),
      tau2,
      forest: data.map((d,i)=>({ id: d.id, val: d[kEff], lo: d[kEff]-1.96*d[kSe], hi: d[kEff]+1.96*d[kSe] }))
    };
  }
</script>

<script>
// --- MAIN THREAD ---

const TRIALS = [
  { id: "NINDS Itt",  logOR_benefit: 0.53, SE_benefit: 0.20, logOR_harm: 2.28, SE_harm: 0.50 },
  { id: "ECASS III",  logOR_benefit: 0.29, SE_benefit: 0.14, logOR_harm: 2.32, SE_harm: 0.40 },
  { id: "ATLANTIS B", logOR_benefit: -0.13,SE_benefit: 0.18, logOR_harm: 2.25, SE_harm: 0.41 },
  { id: "IST-3",      logOR_benefit: 0.30, SE_benefit: 0.16, logOR_harm: 2.10, SE_harm: 0.45 },
  { id: "EPITHET",    logOR_benefit: 0.40, SE_benefit: 0.45, logOR_harm: 2.10, SE_harm: 1.10 }
];

let currentDrug = 'tpa';

const blob = new Blob([document.getElementById('worker-code').textContent], {type: "text/javascript"});
const worker = new Worker(window.URL.createObjectURL(blob));

worker.onmessage = e => {
  if (e.data.type === 'complete') {
    renderCharts(e.data.data);
    generateReport(e.data.data);
    updateNarrative(e.data.data);
    document.getElementById('runBtn').classList.remove('processing');
    document.getElementById('runBtn').disabled = false;
  }
};

function setDrug(d) {
  currentDrug = d;
  document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(d === 'tpa' ? 'btnTPA' : 'btnTNK').classList.add('active');
  
  const tnkOpts = document.getElementById('tnkOptions');
  if (d === 'tnk') {
    tnkOpts.classList.add('visible');
    document.getElementById('drugTag').textContent = 'Tenecteplase';
  } else {
    tnkOpts.classList.remove('visible');
    document.getElementById('drugTag').textContent = 'Alteplase';
  }
  
  startAnalysis();
}

function updateRiskFromScore() {
  const score = parseInt(document.getElementById('dragonInput').value);
  document.getElementById('lblDragon').textContent = score;
  
  const newGood = Math.max(5, 65 - (score * 6));
  document.getElementById('baseB').value = newGood;
  
  const newBleed = Math.max(0.5, 0.5 + (score * 0.8));
  document.getElementById('baseH').value = newBleed.toFixed(1);
  
  updateLabels();
  startAnalysis();
}

function startAnalysis() {
  document.getElementById('runBtn').classList.add('processing');
  document.getElementById('runBtn').disabled = true;

  const tnkModel = document.querySelector('input[name="tnkModel"]:checked').value;

  worker.postMessage({
    trials: TRIALS,
    baseB: parseFloat(document.getElementById('baseB').value)/100,
    baseH: parseFloat(document.getElementById('baseH').value)/100,
    weightH: parseFloat(document.getElementById('harmWeight').value),
    nSims: 50000,
    rho: 0.4,
    timeMin: parseInt(document.getElementById('timeInput').value),
    drugType: currentDrug,
    tnkModel: tnkModel
  });
}

function copyReport() {
  const text = document.getElementById('reportContent').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('.copy-btn');
    const orig = btn.innerHTML;
    btn.innerHTML = "Copied!";
    setTimeout(() => btn.innerHTML = orig, 2000);
  });
}

function generateReport(data) {
  const { stats, reB, reH } = data;
  const time = document.getElementById('timeInput').value;
  const nnt = (1/stats.avgBen).toFixed(0);
  const nnh = (1/stats.avgHarm).toFixed(0);
  const prob = (stats.probPos*100).toFixed(1);
  const harmWeight = parseFloat(document.getElementById('harmWeight').value);
  
  let impact = "uncertain";
  if (stats.probPos > 0.8) impact = "strongly favorable";
  else if (stats.probPos > 0.5) impact = "moderately favorable";
  else impact = "unfavorable";

  // Additional Disclaimers based on state
  let disclaimerTNK = "";
  if (currentDrug === 'tnk') {
    disclaimerTNK = "<br><br><strong>Note on TNK:</strong> The time-decay curve used here is extrapolated from Alteplase (Emberson 2014). While biologically plausible, TNK-specific time-interaction data is limited.";
  }

  let warningHarm = "";
  if (harmWeight > 3.0) {
    warningHarm = "<br><br><strong>Caution:</strong> With a high Harm Weight (>3.0), the Ordinal Shift (Grotta) analysis may not fully capture the trade-off between death and severe disability due to competing hazards.";
  }

  let reportHTML = `
    <div class="report-block">
      <div class="report-h3">1. Efficacy Synthesis</div>
      <p class="report-text">
        At <span class="report-highlight">${time} minutes</span> from onset, the pooled analysis projects a Number Needed to Treat (NNT) of <strong>${nnt}</strong> for one additional patient to achieve functional independence (mRS 0-1). 
        ${time > 180 ? 'Note: This reflects a significant penalty (~35-50% reduction) relative to the <90min efficacy window.' : 'This reflects peak efficacy close to the maximal potential of reperfusion.'}
      </p>
    </div>

    <div class="report-block">
      <div class="report-h3">2. Safety Profile</div>
      <p class="report-text">
        The Number Needed to Harm (NNH) for symptomatic intracranial hemorrhage is projected at <strong>${nnh}</strong>. 
        Given your selected Harm Disutility Weight, the model calculates a decision "Tipping Point" at <strong>${stats.tippingPoint.toFixed(1)}x</strong>. 
        ${stats.tippingPoint < harmWeight ? 'Current weighing suggests risks outweigh benefits.' : 'Your current weight is well below the tipping point, supporting intervention.'}
        ${warningHarm}
      </p>
    </div>

    <div class="report-block">
      <div class="report-h3">3. Clinical Recommendation</div>
      <p class="report-text">
        Based on 50,000 simulations, the probability that ${currentDrug === 'tpa' ? 'Alteplase' : 'Tenecteplase'} provides a net clinical benefit for this specific risk profile is <span class="report-highlight">${prob}%</span>. 
        The overall signal is <strong>${impact}</strong>.
      </p>
      <div class="report-citation">
        Methodology: Log-linear decay (Emberson et al. 2014) applied to pooled OR from NINDS/ECASS/IST-3. TNK assumed non-inferior (AcT Trial).
        ${disclaimerTNK}
      </div>
    </div>
  `;
  
  document.getElementById('reportContent').innerHTML = reportHTML;
}

function updateNarrative(data) {
  const { stats } = data;
  const prob = stats.probPos * 100;
  const time = document.getElementById('timeInput').value;
  
  let headline = "";
  if (prob > 85) headline = `Data Indicates High Probability of Benefit at ${time} min`;
  else if (prob > 55) headline = `Moderate Probability of Benefit at ${time} min`;
  else if (prob > 40) headline = `Equivocal Trade-off (Equipoise) at ${time} min`;
  else headline = `Probability Favors Control at ${time} min`;
  
  document.getElementById('dynamicHeadline').textContent = headline;
  document.getElementById('dynamicSubhead').textContent = `Probability of Net Benefit: ${prob.toFixed(1)}% | Weighted Gain: ${(stats.avgNet*100).toFixed(1)}%`;

  const tip = stats.tippingPoint;
  let tipText = "--";
  if (tip > 10) tipText = "Robust (>10x)";
  else if (tip < 0) tipText = "None";
  else tipText = tip.toFixed(2) + "x";
  document.getElementById('valTip').textContent = tipText;
  
  const delta = (stats.grotta.delta * 100).toFixed(1);
  document.getElementById('shiftMetric').textContent = `mRS 0-1 Gain: +${delta}%`;
}

function renderCharts(data) {
  const { reB, reH, plotPoints, histData, stats } = data;
  
  document.getElementById('valNCB').textContent = (stats.avgNet*100).toFixed(2) + '%';
  document.getElementById('valProb').textContent = (stats.probPos*100).toFixed(1) + '%';
  document.getElementById('valNNT').textContent = stats.avgBen > 0.001 ? (1/stats.avgBen).toFixed(0) : "∞";
  document.getElementById('valNNH').textContent = stats.avgHarm > 0.001 ? (1/stats.avgHarm).toFixed(0) : "∞";

  drawWaffle(document.getElementById('waffleCanvas'), stats);
  drawDensity(document.getElementById('mainCanvas'), plotPoints);
  drawForest(document.getElementById('forestCanvas'), reB);
  drawHist(document.getElementById('histCanvas'), histData);
  drawDecay(document.getElementById('decayCanvas'), parseInt(document.getElementById('timeInput').value));
  drawGrotta(document.getElementById('grottaCanvas'), stats.grotta);
}

// --- Chart Engines ---
function setupCanvas(c) {
  const dpr = window.devicePixelRatio || 1;
  const rect = c.getBoundingClientRect();
  c.width = rect.width * dpr; c.height = rect.height * dpr;
  const ctx = c.getContext('2d');
  ctx.scale(dpr, dpr);
  return { ctx, w: rect.width, h: rect.height };
}

function drawGrotta(c, data) {
  const { ctx, w, h } = setupCanvas(c);
  ctx.fillStyle = '#171717'; ctx.fillRect(0,0,w,h);
  
  const pad = {l: 60, r: 20, t: 40, b: 40};
  const barH = 40;
  const gap = 30;
  const colors = ['#22c55e', '#86efac', '#fde047', '#fdba74', '#fb923c', '#fca5a5', '#ef4444'];
  
  let x = pad.l;
  let y = pad.t;
  ctx.fillStyle = '#a3a3a3'; ctx.font='10px Inter'; ctx.textAlign='right'; ctx.fillText("Control", x-10, y+barH/2+3);
  data.base.forEach((p, i) => {
    const width = p * (w - pad.l - pad.r);
    ctx.fillStyle = colors[i]; ctx.fillRect(x, y, width, barH); x += width;
  });

  x = pad.l; y = pad.t + barH + gap;
  ctx.fillStyle = '#a3a3a3'; ctx.textAlign='right'; ctx.fillText("Treated", x-10, y+barH/2+3);
  data.treat.forEach((p, i) => {
    const width = p * (w - pad.l - pad.r);
    ctx.fillStyle = colors[i]; ctx.fillRect(x, y, width, barH); x += width;
  });
  
  ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth = 1;
  let cx1 = pad.l; let cx2 = pad.l;
  for(let i=0; i<6; i++) {
    cx1 += data.base[i] * (w-pad.l-pad.r); cx2 += data.treat[i] * (w-pad.l-pad.r);
    ctx.beginPath(); ctx.moveTo(cx1, pad.t+barH); ctx.lineTo(cx2, pad.t+barH+gap); ctx.stroke();
  }
}

function drawDecay(c, currentTime) {
  const { ctx, w, h } = setupCanvas(c);
  ctx.fillStyle = '#1e1e1e'; ctx.fillRect(0,0,w,h);
  const pad = {l: 30, r: 20, t: 20, b: 30};
  
  ctx.beginPath();
  ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
  for(let t=0; t<=360; t+=5) {
    const meanOR = Math.max(1.0, 1.8 - (0.00296 * t));
    const se = 0.05 + (t/360)*0.15; 
    const hi = meanOR + 1.96*se;
    const x = pad.l + (t/360)*(w-pad.l-pad.r);
    const y = pad.t + (1 - (hi-1.0)/1.2)*(h-pad.t-pad.b); 
    if(t===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  for(let t=360; t>=0; t-=5) {
    const meanOR = Math.max(1.0, 1.8 - (0.00296 * t));
    const se = 0.05 + (t/360)*0.15; 
    const lo = Math.max(0.8, meanOR - 1.96*se);
    const x = pad.l + (t/360)*(w-pad.l-pad.r);
    const y = pad.t + (1 - (lo-1.0)/1.2)*(h-pad.t-pad.b); 
    ctx.lineTo(x,y);
  }
  ctx.fill();

  ctx.beginPath();
  ctx.strokeStyle = '#a3a3a3'; ctx.lineWidth = 2;
  for(let t=0; t<=360; t+=5) {
    const or = Math.max(1.0, 1.8 - (0.00296 * t));
    const x = pad.l + (t/360)*(w-pad.l-pad.r);
    const y = pad.t + (1 - (or-1.0)/1.2)*(h-pad.t-pad.b);
    if(t===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  
  const curOR = Math.max(1.0, 1.8 - (0.00296 * currentTime));
  const cx = pad.l + (currentTime/360)*(w-pad.l-pad.r);
  const cy = pad.t + (1 - (curOR-1.0)/1.2)*(h-pad.t-pad.b);
  
  ctx.fillStyle = 'var(--accent)';
  ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI*2); ctx.fill();
  
  ctx.strokeStyle='#404040'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx, h-pad.b); ctx.stroke();
  
  ctx.fillStyle='#a3a3a3'; ctx.textAlign='center';
  ctx.fillText(currentTime+"m", cx, h-10);
}

function drawForest(c, meta) {
  const { ctx, w, h } = setupCanvas(c);
  ctx.fillStyle = '#1e1e1e'; ctx.fillRect(0,0,w,h);
  const pad = {l:70, r:30, t:30, b:30};
  const sx = v => pad.l + ((v+1)/3.5)*(w-pad.l-pad.r);
  
  ctx.strokeStyle = '#525252'; ctx.lineWidth=2; ctx.beginPath();
  ctx.moveTo(sx(0), pad.t); ctx.lineTo(sx(0), h-pad.b); ctx.stroke();
  
  const rowH = (h-pad.t-pad.b)/(meta.forest.length+2);
  ctx.font = '10px Inter'; ctx.textBaseline='middle';
  
  meta.forest.forEach((f,i) => {
    const y = pad.t + rowH*(i+0.5);
    ctx.strokeStyle='#a3a3a3'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(sx(f.lo), y); ctx.lineTo(sx(f.hi), y); ctx.stroke();
    ctx.fillStyle='var(--accent)'; ctx.fillRect(sx(f.val)-4, y-4, 8, 8);
    ctx.fillStyle='#a3a3a3'; ctx.textAlign='right'; ctx.fillText(f.id, pad.l-10, y);
  });
  
  const yD = h - pad.b - 5;
  const hw = (sx(meta.mu + 1.96*meta.se_pool) - sx(meta.mu - 1.96*meta.se_pool))/2;
  const cx = sx(meta.mu);
  ctx.fillStyle = 'var(--success)';
  ctx.beginPath(); ctx.moveTo(cx-hw, yD); ctx.lineTo(cx, yD-5); ctx.lineTo(cx+hw, yD); ctx.lineTo(cx, yD+5); ctx.fill();
  
  ctx.strokeStyle = '#f87171'; ctx.lineWidth = 2;
  ctx.beginPath(); 
  ctx.moveTo(sx(meta.pi_lo), yD); ctx.lineTo(cx-hw, yD); 
  ctx.moveTo(cx+hw, yD); ctx.lineTo(sx(meta.pi_hi), yD); 
  ctx.stroke();
  
  ctx.beginPath();
  ctx.moveTo(sx(meta.pi_lo), yD-4); ctx.lineTo(sx(meta.pi_lo), yD+4);
  ctx.moveTo(sx(meta.pi_hi), yD-4); ctx.lineTo(sx(meta.pi_hi), yD+4);
  ctx.stroke();
}

function drawWaffle(c, stats) {
  const { ctx, w, h } = setupCanvas(c);
  const cols = 10, rows = 10; const gap = 4;
  const dotSize = Math.min((w - (cols-1)*gap)/cols, (h - (rows-1)*gap)/rows) * 0.8;
  const nBen = Math.round(stats.avgBen * 100); const nHarm = Math.round(stats.avgHarm * 100);
  const gridW = cols * dotSize + (cols-1) * gap; const gridH = rows * dotSize + (rows-1) * gap;
  const offX = (w - gridW) / 2; const offY = (h - gridH) / 2;
  let counts = { ben: 0, harm: 0 };
  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      let color = '#333'; 
      if (counts.harm < nHarm) { color = '#ef4444'; counts.harm++; }
      else if (counts.ben < nBen) { color = '#10b981'; counts.ben++; }
      ctx.fillStyle = color; ctx.beginPath();
      ctx.arc(offX + x * (dotSize + gap) + dotSize/2, offY + y * (dotSize + gap) + dotSize/2, dotSize/2, 0, Math.PI*2);
      ctx.fill();
    }
  }
}

function drawDensity(c, pts) {
  const { ctx, w, h } = setupCanvas(c);
  ctx.fillStyle = '#1e1e1e'; ctx.fillRect(0,0,w,h);
  const pad = {l:40, r:20, t:20, b:40};
  const sx = v => pad.l + ((v+5)/30)*(w-pad.l-pad.r); const sy = v => pad.t + (1-(v+2)/17)*(h-pad.t-pad.b); 
  ctx.strokeStyle = '#333'; ctx.lineWidth=1; ctx.beginPath();
  ctx.moveTo(sx(0), pad.t); ctx.lineTo(sx(0), h-pad.b); ctx.moveTo(pad.l, sy(0)); ctx.lineTo(w-pad.r, sy(0)); ctx.stroke();
  ctx.fillStyle = 'rgba(96, 165, 250, 0.15)';
  for(let p of pts) { ctx.beginPath(); ctx.arc(sx(p.b*100), sy(p.h*100), 2.5, 0, Math.PI*2); ctx.fill(); }
  ctx.fillStyle = '#a3a3a3'; ctx.textAlign='center'; ctx.font='10px Inter';
  ctx.fillText("Benefit (%)", pad.l+(w-pad.l-pad.r)/2, h-10);
}

function drawHist(c, bins) {
  const { ctx, w, h } = setupCanvas(c);
  ctx.fillStyle = '#1e1e1e'; ctx.fillRect(0,0,w,h);
  const pad = {l:30, r:10, t:20, b:30};
  const maxY = Math.max(...bins.map(b=>b.y)); const minX = bins[0].x; const rangeX = bins[bins.length-1].x - minX;
  const sx = v => pad.l + ((v-minX)/rangeX)*(w-pad.l-pad.r); const sy = v => pad.t + (1 - v/maxY)*(h-pad.t-pad.b);
  const barW = (w-pad.l-pad.r)/bins.length;
  bins.forEach(b => {
    ctx.fillStyle = b.x > 0 ? '#10b981' : '#ef4444';
    const hBar = (h-pad.t-pad.b) - (sy(b.y)-pad.t); ctx.fillRect(sx(b.x), sy(b.y), barW+1, hBar); 
  });
  ctx.strokeStyle='#fff'; ctx.lineWidth=1; ctx.setLineDash([2,2]);
  ctx.beginPath(); ctx.moveTo(sx(0), pad.t); ctx.lineTo(sx(0), h-pad.b); ctx.stroke();
}

function updateLabels() {
  document.getElementById('lblBaseB').textContent = document.getElementById('baseB').value + '%';
  document.getElementById('lblBaseH').textContent = document.getElementById('baseH').value + '%';
  document.getElementById('lblWeight').textContent = document.getElementById('harmWeight').value + 'x';
  document.getElementById('lblTime').textContent = document.getElementById('timeInput').value + ' min';
}

document.querySelectorAll('input[type="range"]').forEach(el => {
  el.addEventListener('input', updateLabels);
  el.addEventListener('change', startAnalysis);
});
window.onload = () => { updateLabels(); startAnalysis(); };

</script>
</body>
</html>
